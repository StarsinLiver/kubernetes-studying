<!-- 설치 -->
# 초콜레티를 사용한 설치(윈도우)
choco install -y kubernetes-helm

# 홈브루를 사용한 설치(macOS)
brew install helm

# 헬름 설치 스크립트를 사용한 설치(리눅스)
curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash

# 설치가 잘 되었는지 확인
helm version

<!-- 리포지터리 -->
# 원격 서버를 가리키는 이름으로 리포지터리를 추가
# 공개된 헬름 리포지터리를 많이 찾아볼수있으며, 직접 서버를 운영할 수도 있다.
# 지금 추가한 것은 이책의 헬름 리포지터리다.
helm repo add kiamol https://kiamol.net

# 로컬 리포지터리 캐시를 업데이트
# 레포지터리를 업데이트하면 패키지 인덱스를 내려받아 인덱스를 캐시한다.
helm repo update

# 인덱스 캐시로부터 애플리케이션을 검색
helm search repo vweb --versions

<!-- 차트 -->
# 차트에 포함된 파라미터 값의 기본값을 확인
helm show values kiamol/vweb --version 1.0.0

# 파라미터 값의 기본값을 수정해 차트를 설치
# helm install 명령의 set 인자로 파라미터 값에 원하는 값을 지정할 수 있다.
helm install --set servicePort=8010 --set replicaCount=1 ch10-vweb kiamol/vweb --version 1.0.0

# 설치된 릴리스를 확인 (우리가 설치한 차트 : 릴리스)
helm ls

<!-- 릴리스 -->
# 릴리스의 목록 확인
helm ls -q

# 임시로 설치한 릴리스 삭제/제거
helm uninstall 릴리스이름

# 릴리스의 현재 설정값을 확인
helm get values 릴리스이름

# 릴리스 히스토리(버전 , 업데이트일자 등)를 확인
helm history 릴리스이름

# 최근 두 리비전의 정보를 확인
helm history 릴리스이름 --max 2 -o yaml

# 현재 릴리스의 설정값을 YAML 파일로 저장
helm get values 릴리스이름 -o yaml > 아무이름.yaml

# 리비전 2에 적용된 설정값을 확인
helm get values 릴리스이름 --revision 2

# kubectl로 확인하고 싶은때
# 디플로이먼트의 상태를 확인
kubectl get deploy -l app.kubernetes.io/instance=ch10-vweb --show-labels
# 레플리카셋의 상태를 확인
kubectl get deploy -l app.kubernetes.io/instance=ch10-vweb --show-labels

<!-- 롤아웃 : 업그레이드 -->
# 레플리카 수를 변경하여 현재 릴리스를 업데이트
# helm upgrade 명령에서 서비스 포트를 다시 지정하지 않으면 포트가 기본값으로 바뀌게 된다.
helm upgrade --set servicePort=8010 --set replicaCount=3 ch10-vweb kiamol/vweb --version 1.0.0

# 기존 릴리스 설정값을 재사용하여 버전 2로 업그레이드
# reuse-values 플래그는 현재 릴리스에 사용된 설정값을 그대로 새 릴리스에도 사용하라는 의미
# kubectl을 이용한 배치에서 같은 문제가 일어나면, 실패한 것은 리소스 하나인데도 다른 리소스를 일일이 확인하며 수동으로 롤백해야 한다.
# --atomic 플래그를 사용하면 이 작업을 자동으로 해준다. 
helm upgrade --reuse-values --atomic ch10-vweb(릴리스이름) kiamol/vweb(차트명) --version 2.0.0

# --atomic 플래그와 저장된 설정값 파일을 사용해서 버전 2로 업그레이드
helm upgrade -f vweb-values.yaml --atomic ch10-vweb kiamol/vweb --version 2.0.0


<!-- 릴리스 설치 : install -->
# lint 명령은 로컬에서 작업 중인 차트에서만 사용할 수 있지만, install 명령은 로컬에서 작업 중인 차트와 리포지터리에서 내려받은 차트 모두에서 사용할 수 있다
# 차트에 들어갈 파일의 유효성을 검증
# lint 명령은 차트가 유효한지 검증하는 기능을 제공한다. 차트 설치에 실패할 수 있는 원인을 짚어 오류로 출력해준다.
helm lint 디렉터리경로

# lint 명령은 로컬에서 작업 중인 차트에서만 사용할 수 있지만, install 명령은 로컬에서 작업 중인 차트와 리포지터리에서 내려받은 차트 모두에서 사용할 수 있다
# 차트 디렉터리에서 릴리스를 설치
helm install wp1(지정할 릴리스 이름) 디렉터리경로

# 설정값 파일을 사용하여 차트를 설치
helm install -f web-ping-values.yaml wp3 local/web-ping

<!-- values.yaml -->
# 차트에서 설정가능한 값을 확인 (로컬)
helm show values 디렉터리경로

# wp2라는 이름으로 요청 대상 URL을 달리한 릴리스를 추가 배치
helm install --set targetUrl=kiamol.net wp2 .\web-ping\

<!-- ChartMuseum : 오픈 소스 웹 서버 기능 설치법 -->
# 공식 헬름 리포지터리(도커 허브와 비슷하게 큐레이션을 거친 리포지터리)를 stable 이름으로 추가
helm repo add stable https://charts.helm.sh/stable

# 차트뮤지엄 설치 - repo 옵션을 사용하면 리포지터리의 상세 정보를
# 받아오므로 로컬 캐시를 업데이트하지 않아도 된다
helm install --set service.type=LoadBalancer --set service.externalPort=8008 --set env.open.DISABLE_API=false repo stable/chartmuseum --version 2.13.0 --wait

# 로컬에 설치된 차트뮤지엄의 URL
kubectl get svc repo-chartmuseum -o jsonpath='http://{.status.loadBalancer.ingress[0].*}:8008'

# 설치된 차트뮤지엄을 local이라는 이름으로 리포지터리 등록
helm repo add local $(kubectl get svc repo-chartmuseum -o jsonpath='http://{.status.loadBalancer.ingress[0].*}:8008')

<!-- 차트 패키징 , 배포 -->
# 로컬에 위치한 차트를 패키징
# 차트를 패키징하면 압축 파일 형태의 아티팩트가 된다. 아티팩트는 서버에 업로드할 수 있다.
helm package 디렉터리경로

# (윈도우 10 환경 한정) 진짜 curl을 사용하도록 파워셀의 앨리어스를 제거한다.
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch10> Remove-Item Alias:curl -ErrorAction Ignore

# 패키징된 차트의 압축 파일을 차트뮤지엄에 업로드
# 차트뮤지엄에는 차트 압축 파일을 업로드하는 API를 제공한다. 이 API는 curl 을 사용하여 압축파일을 전송한다.
curl --data-binary "@web-ping-0.1.0.tgz" $(kubectl get svc repo-chartmuseum -o jsonpath='http://{.status.loadBalancer.ingress[0].*}:8008/api/charts')

# 차트뮤지엄의 인덱스에서 새로운 차트를 확인
# 리포지터리 인덱스에 새로운 차트 정보가 추가되었다. 차트의 메타데이터는 chart.yaml 파일의 정보를 읽은 것이고, 여기에 압축 파일을 내려받을 수 있는 URL과 내려받은 파일 내용을 검증하기 위한 해시값이 추가된다.
curl $(kubectl get svc repo-chartmuseum -o jsonpath='http://{.status.loadBalancer.ingress[0].*}:8008/index.yaml')

<!-- 하위 차트와 패키징 , 배포 -->
# 하위 차트를 빌드
helm dependency build 디렉토리경로

# --dry-run : 설정 기본값을 적용해서 오류 여부를 검증
# dry-run 기능은 템플릿 변수를 모두 치환하여 YAML 파일을 완성하지만 실제로 애플리케이션은 배치하지 않는다.
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch10> helm install 릴리스이름 .\디렉터리경로\ --dry-run

<!-- 롤백 -->
# 리비전 2로 롤백
helm rollback 릴리스이름 2

<!-- 제거 -->
# 모든 릴리스를 제거
helm uninstall 릴리스이름
helm uninstall $(helm ls -q)

<!-- Job : 테스트 -->
# 헬름을 사용해 테스트 잡을 실행
helm test 릴리스이름