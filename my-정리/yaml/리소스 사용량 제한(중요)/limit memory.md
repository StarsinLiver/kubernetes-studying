<!-- 계산 리소스를 관리하여 애플리케이션 및 노드 보호하기 -->
# 컨테이너는 애플리케이션 프로세스가 거주하는 가상화된 환경이다.
# 쿠버네티스는 이런 가상 환경을 만드는 역할을 한다.
# 파일 시스템이나 네트워크와 마찬가지로 컨테이너환경에는 메모리와 CPU도 포함된다.
# 쿠버네티스는 이런 요소 역시 관리할 수 있는데, 초기 설정에서 메모리와 CPU는 쿠버네티스의 관리 대상이 아니다.
# 다시 설명하자면 파드 컨테이너는 자신이 동작 중인 노드의 CPU나 메모리를 끌어다 사용하는데 특별한 제한이 없다.
# 여기에는 두가지 문제가 있다. 

# 첫번째는 메모리가 고갈되어 애플리케이션이 강제 종료될 위험이 있다는 것이고, 두번째는 다른 애플리케이션을 실행할 노드의 리소스가 부족해질 수 있다는 점이다.
# 파드 정의에서 컨테이너가 사용할 수 있는 리소스 총량을 제한할 수 있다.
# 컨테이너 프로브와 마찬가지로 운영 환경에서는 빼놓을 수 없는 설정이다.
# 메모리 누수 중상을 보이는 애플리케이션은 아주 쉽게 클러스터를 망가뜨릴수 있다.


<!-- memory-allocator-with-limit.yaml -->
apiVersion: apps/v1
kind: Deployment
metadata:
  name: memory-allocator
  labels:
    kiamol: ch12
spec:
  selector:
    matchLabels:
      app: memory-allocator
  template:
    metadata:
      labels:
        app: memory-allocator
    spec:                             # 디플로이먼트 정의에 포함된 파드 정의
      containers:
        - name: api
          image: kiamol/ch12-memory-allocator
          resources:
            limits:                   # 컨테이너가 사용할 수 있는 계산 리소스를 제한한다.
              memory: 50Mi            # 여기에서는 메모리 사용량은 50MB로 제한했다.

# 리소스 제한은 컨테이너 수준에서 지정된다.
# 하지만 파드 정의에 포함되는 내용이므로 업데이트를 적용하면 파드가 새 파드로 대체된다.
# 파드를 대체하면 메모리 사용량이 0으로 돌아가 5초마다 10MB씩 증가한다.
# 하지만 이번에는 쿠버네티스가 메모리 사용량을 50MB로 제한한다.