<!-- 인그레스를 이용한 인입 트래픽 관리 -->
# 서비스는 외부에서 들어오는 트래픽을 쿠버네티스안으로 인도하는 역할을 한다.
# 지금까지 우리는 우베 애플리케이션에 외부 사용자가 접근할 수 있도록 여러 개의 로드밸런서 서비스를 사용했다.
# 이 방법은 애플리케이션마다 IP주소를 따로 부여하고 부여된 주소와 애플리케이션 관계를 DNS 서버에서 제공해야 하기 때문에 관리적인 문제가 발생하기 쉽다.
# 인입되는 트래픽을 올바른 애플리케이션으로 연결하는 일은 라우팅과 관련된 문제이지만, 인그레스(Ingress)를 사용하면 이를 쿠버네티스 안에서도 다룰 수 있다.

<!-- 인그레스(ingress) -->
# 도메인 네임을 이용한 라우팅과 관련된 문제는 리버스 프록시(reverse proxy)로 거의 해결할 수 있는데, 쿠버네티스의 인그레스는 플러그인이 가능한 아키텍처가 적용되었다.
# 따라서 라우팅 규칙을 일반적인 쿠버네티스 리소스로 정의하고 리버스 프록시로 사용할 컴포넌트에 이 규칙에 따라 트래픽을 처리하도록 하는 구조다.
# 비교적 최근 출시되어 컨테이너와 연동 가능한 것들을 포함해서 모든 주요 리버스 프록시는 쿠버네티스를 지원한다.
# 이들 리버스 프록시는 기능과 동작 모델이 제각각이다.
# 이 장에서는 인그레스를 사용하여 클러스터에서 두 개 이상의 애플리케이션을 호스팅하는 방법과 함께 대표적인 리버스 프록시인 Nginx와 Trafik을 다룬다.

<!-- 인그레스의 라우팅 과정 -->
# 인그레스는 리버스 프록시를 인그레스 컨트롤러(ingress controller)로 사용하여 리버스 프록시에 좀 더 주도적인 역할을 맡긴다.
# 하지만 전체적인 구도는 크게 다르지 않다. 리버스 프록시는 로드밸런서 서비스에서 외부 트래픽을 받아들이고, 클러스터 IP서비스 형태로 된 애플리케이션에서 요청한 콘텐츠를 받아 와 제공하는 구도는 그대로다.

# 인그레스 서비스는 외부로 노출되는 유일한 서비스다. 클라우드의 로드밸런서나 데이터센터의 노드포트(NodePort)와 같은 역할을 한다.

# 인그레스 컨트롤러는 리버스 프록시의 일종이다. 외부에서 들어오는 모든 요청을 받아들이고 이에 따라 적절한 애플리케이션에서 콘텐츠를 가져오는 역할을 한다.

# 핵심은 인그레스 컨트롤러다. 이 컨트롤러는 쉽게 교체할 수 있는 리버스 프록시라고 볼 수 있다.
# HAProxy, Nginx, 컨투어 , 트래픽 등 다양한 선택지가 있다.
# 인그레스 객체에는 라우팅 규칙이 일반적인 형태로 기술되어 있고, 이 규칙을 프록시에 적용한다.
# 프록시마다 기능에 차이가 있으므로 인그레스 정의에는 공통적인 내용만 담기며, 애너테이션으로 특정 프록시만 지원하는 기능을 추가하낟.

<!-- 실습 -->
# 이번에는 애플리케이션을 내부 접근만 가능한 클러스터IP 서비스로 배치하고 Nginx 인그레스 컨트롤러를 사용하여 이 서비스에 트래픽을 라우팅한다.

# 이번 장 예제 코드 디렉터리로 이동
cd ch15

# Hello World 애플리케이션을 배치
kubectl apply -f hello-kiamol/

# 배치된 서비스 객체가 내부 접근만 가능한지 확인
kubectl get svc hello-kiamol

# 애플리케이션에 포트포워드 설정을 추가
kubectl port-forward svc/hello-kiamol 8015:80

# http://localhost:8015를 확인
# 확인 후 Ctrl+C 또는 Cmd-C를 눌러 포트포워딩 종료

<!-- 인그레스 컨트롤러 -->
# 인그레스 규칙에 따라 애플리케이션에 접근할 수 있도록 하려면 먼저 인그레스 컨트롤러가 필요하다 앞서 설명했듯이 컨트롤러는 다른 객체를 관리하는 객체다.
# 디플로이먼트는 레플리카셋을 관리하고 레플리카셋은 파드를 관리한다. 그러나 인그레스 컨트롤러는 이들과 약간 다르다.
# 인그레스 컨트롤러는 파드에서 실행되며 인그레스 객체를 감시한다.
# 그러다 어떤 변경을 감지하면 프록시에 변경된 규칙을 적용한다. 우선 Nginx 인그레스 컨트롤러를 다루어 보자. 이 컨트롤러는 넓은 범위의 쿠버네티스 프로젝트 일부다.


<!-- 실습 2 -->
# Nginx 인그레스 컨트롤러를 배치하라 이 서비스는 HTTP와 HTTPS의 표준 포트를 사용하므로 80번과 443번 포트가 사용 가능한 상태여야한다.

# (역주) 실습 환경(k3s 기준)에 Traefik이 기본 포함된 경우 포트가 점유되서 오류가 발생하므로 다음 명령으로 Traefik을 수동 제거한 후 진행한다.
kubectl -n kube-system delete helmcharts.helm.cattle.io traefik

# Nginx 인그레스 컨트롤러의 디플로이먼트 및 서비스를 배치
kubectl apply -f ingress-nginx/
namespace/kiamol-ingress-nginx created
configmap/ingress-nginx-controller created
service/ingress-nginx-controller created
deployment.apps/ingress-nginx-controller created
serviceaccount/ingress-nginx created
clusterrole.rbac.authorization.k8s.io/ingress-nginx created
clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx created
role.rbac.authorization.k8s.io/ingress-nginx created
rolebinding.rbac.authorization.k8s.io/ingress-nginx created

# 서비스가 준비되었는지 확인
kubectl get svc -n kiamol-ingress-nginx

# 프록시 URL을 확인
kubectl get svc ingress-nginx-controller -o jsonpath='http://{.status.loadBalancer.ingress[0].*}' -n kiamol-ingress-nginx

# URL에 접근(에러가 발생한다)

# 웹 브라우저에서 404 오류가 발생한다. 이 결과를 볼때 프록시가 트래픽을 받아 이를 인그레스 컨트롤러로 전달하는 것까지는 알 수 있다.
# 하지만 Nginx에 이 트래픽을 처리할 라우팅 규칙이 없기 대문에 응답할 콘텐츠도 없다.
# 따라서 기본으로 설정된 "문서를 찾을 수 없음"페이지가 나타난 것이다.

<!-- 인그레스 객체 배치해보자 -->
# 애플리케이션과 인그레스 컨트롤러가 준비되었으니 인그레스 컨트롤러에 라우팅 규칙을 전달할 인그레스 객체를 배치할 차례다.
# 모든 요청을 Hello World 애플리케이션으로 전달하도록 했다.

# 인그레스 컨트롤러는 인그레스 객체의 추가나 변경을 감시한다.
# 따라서 인그레스 객체를 새로 배치하면 객체에 담긴 라우팅 규칙이 Nginx 설정에 추가된다. Nginx 관점에서 보면 hello-kiamol 서비스를 업스트림(콘텐츠를 받아 올 곳)으로 삼는 프록시 서버가 설정되는 것과 같은 결과를 낳는다.
# 그리고 루트 경로에 대한 요청에 hello-kiamol의 콘텐츠를 제공한다.

<!-- local.yaml -->
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hello-kiamol
  labels:
    kiamol: ch15
spec:
  rules:
  - http:                         # 인그레스는 HTTP/HTTPS 트래픽만 다룬다.
      paths:
      - path: /                   # 모든 요청을
        pathType: Prefix
        backend:                  # hello-kiamol 서비스로 전달한다.
          service:
            name: hello-kiamol
            port:
              number: 80        

<!-- 실습 3 -->
# Hello World 애플리케이션을 제공하도록 하는 라우팅 규칙이 담긴 인그레스 객체를 배치하라

# 라우팅 규칙이 담긴 인그레스 객체를 배치
kubectl apply -f hello-kiamol/ingress/localhost.yaml

# 인그레스 객체가 생성되었는지 확인
kubectl get ingress

# 앞서 예제의 웹 브라우저 창을 새로고침하라

# 애플리케이션에 해당하는 백엔드 서비스에 경로를 매핑하는 정보를 인그레스 객체의 정의에 기재만 하면 된다.
# 이전 요청에서 404 오류가 나타났으나 이번에는 Hello World 애플리케이션이 잘 동작했다.

# 인그레스는 로그나 모니터링 관련 컴포넌트가 그렇듯이 대개 클러스터 전체를 관장한다.
# 보통은 인프라 조직에서 인그레스 컨트롤러의 배치 및 관리를 맡고, 각 프로덕트 담당 팀이 자신의 애플리케이션으로 트래픽을인도하는 인그레스 객체를 관리한다.
# 하지만 이런 프로세스에서 충돌이 발생할 수도 있다. 인그레스 라우팅 규칙은 유일하지 않아도 된다.
# 그래서 어떤 팀에서 수정한 규칙이 다른 팀이 담당한 애플리케이션의 트래픽을 엉뚱한 곳으로 보내게 될 수도 있다.
# 그러나 보통은 애플리케이션이 서로 다른 도메인에서 호스팅되며, 인그레스 라우팅 규칙에도 도메인 네임이 명시되어 범위가 제한되어 있기때문에 이런 일은 잘 발생하지 않는다.