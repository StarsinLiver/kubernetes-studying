<!-- 폴리시, 컨텍스트, API 접근제어를 이용한 애플리케이션 보안 -->
# 컨테이너는 애플리케이션의 프로세스를 감싸는 경량 래퍼다.
# 컨테이너는 호스트 머신의 운영체제에 포함된 커널을 사용하기 때문에 실행이 빠르며 오버헤드도 적다.
# 그만큼 컨테이너는 매우 효율적이지만, 완전한 단절을 어느정도 포기했기 때문에 보안상 위험이 있다.
# 그리고 공격에 노출된 컨테이너는 같이 실행되는 컨테이너는 물론이고 자신을 실행하는 서버까지 함께 공격에 노출시킬 수 있다.
# 물론 쿠버네티스에도 보안을 위한 여러 수단이 있지만 기본적으로 이들 기능은 비활성화되어 있다.

# 쿠버네티스에서 실행중인 애플리케이션 보안을 강화한다는 것은 그만큼 컨테이너 기능을 제약한다는 의미다. 따라서 애플리케이션 취약점을 통해 공격자가 컨테이너에서 원하는 명령을 실행하더라도 그 영향력이 해당 컨테이너 외부에는 미치지 못한다.
# 이렇게 하려면 네트워크를 제한하여 컨테이너가 다른 컨테이너나 쿠버네티스 API, 마운트된 호스트 파일 시스템에 불필요한 접근을 막고, 컨테이너에서 사용할 수 있는 운영체제 기능도 꼭 필요한 것만 제한해야한다.

<!-- 네트워크 폴리시를 이용하여 컨테이너 통신 제약하기 -->
# 네트워크 접근을 최소한으로 억제하는 것은 애플리케이션 보안의 기본적인 수단이다.
# 쿠버네티스의 네트워크는 수평적 모델을 채택하고 있기 때문에 모든 파드가 IP주소만 있으면 다른 어떤 파드라도 접근할 수 있으며 서비스 역시 클러스터 전체에서 접근할 수 있다.

# 15장에서는 인그레스 객체를 사용하여 HTTP 라우팅을 제어하는 방법을 알아보았다.
# 하지만 인그레스 객체의 접근 제어는 외부에서 클러스터로 인입되는 트래픽만 제어할 수 있다.
# 클러스터 내 트래픽 역시 같은 방식으로 제어할 수 있는 수단이 필요하다
# 이를 위해 만든 기능이 바로 네트워크 폴리시(Network Policy)이다.

<!-- 네트워크 폴리시(Network Policy) -->
# 네트워크 폴리시는 포트 단위로 파드 사이의 트래픽을 차단하며 마치 방화벽처럼 동작한다.
# 차단 규칙은 유연하며 레이블 셀렉터로 대상을 식별한다.
# 모든 파드에서 트래픽을 발송하지 못하게 하는 전면 차단 정책위에 파드의 측정값 포트를 모니터링과 관련된 네임스페이스에만 공개하도록 해 꼭 필요한 부분만 개방하는 정책을 정의한다.

# 네트워크 폴리시 정책은 유연하며, 클러스터 전체에 적용되는 기본 정책과 파드별로 기본 정책을 오버라이드하는 정책 모두 가능하다

# 기본정책이란 모든 네임스페이스의 모든 파드가 트래픽을 발송하지 못하게 하는 전면 차단 정책이다.

# 네트워크폴리시(Network Policy) 객체는 별도의 리소스다. 

<!-- 실습 : 네트워크 폴리시가 전혀 적용되지 않은 채 출시된 애플리케이션을 배치해 보고 어떤 문제가 생길 수 있는지 알아보자 -->
# 오늘의 천체 사진(APOD)애플리케이션을 배치하고 다른 포드에서 애플리케이션의 컴포넌트에 접근 가능한지 확인하라

# 이번 장의 예제 코드 디렉터리로 이동하기
cd ch16

# APOD 애플리케이션을 배치하기
kubectl apply -f apod/

# 파드가 준비될 때까지 대기하기
kubectl wait --for=condition=ContainersReady pod -l app=apod-web

# localhost 8016번 포트를 통해
# 오늘의 천체 사진을 볼 수 있는지 확인한다
# (Rancher Desktop의 경우 앞에서 나오던 주소를 사용해야 한다)
# (예: http://172.24.115.0:8016)

# sleep 파드를 실행하기
kubectl apply -f sleep.yaml

# sleep 파드에서 APOD API를 사용할 수 있는지 확인하기
kubectl exec deploy/sleep -- curl -s http://apod-api/image
{"url":"https://apod.nasa.gov/apod/image/2401/GrivolaMoon_Micon_1080.jpg","caption":"Shadows of Mountain and Moon","copyright":"\nEnzo Massa Micon\n"}

# 측정값 엔드포인트를 통해 APOD API의 로그를 확인하기
kubectl exec deploy/sleep -- sh -c 'curl -s http://apod-log/metrics | head -n 2'
# HELP access_log_total Access Log - total log requests
# TYPE access_log_total counter

# 이번 예제에서 확실한 문제점을 발견할 수 있다. 클러스터 전체가 서로 활짝 열러있는 생태라는 점이다.
# sleep 파드에서 APOD 애플리케이션의 API 파드를 아무 제한 없이 접근할 수 있다는 것을 로그에서 확인했다.

# 파드는 자신에게 필요한 컴포넌트에서 온 트래픽만 받아들이고, 자신에게 필요한 컴포넌트에만 트래픽을 보낼 수 있도록 고립되어야한다.
# 네트워크 폴리시는 인그레스 규칙(인그레스 리소스와 혼동하지 않도록 주의)형태로 인입 트래픽을 제어하고, 인그레스 규칙으로 발송되는 트래픽을 제어한다.

<!-- 네트워크 폴리시 : 레이블을 이요한 접근 제한 설정 -->
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy         # kind : 네트워크 폴리시
metadata:
  name: apod-api
  labels:
    kiamol: ch16
spec:
  podSelector:              # 정책이 적용될 대상 파드를 지정
    matchLabels:
      app: apod-api
  ingress:                  # 기본 정책이 거부되므로
  - from:                   # 이 정책은 인입되는 트래픽을 모두 거부하되
    - podSelector:          # 트래픽의 발송처가 apod-web 레이블이 부여된
        matchLabels:        # 파드일 때만 받아들이는 정책이 된다.
          app: apod-web
    ports:                  # 제약의 단위는 포트
    - port: api             # api 파드의 정의에 포함된 포트 이름

# 이들 규칙은 애플리케이션보다 먼저 배치되므로 파드는 시작과 동시에 안전한 상태가 된다.
# 인그레스 및 이그레스(egress) 규칙은 동일한 패턴으로 기술되며 파드와 마찬가지로 네임스페이스 셀렉터를 사용할 수 있다.
# 이런 방법으로 전역 규칙을 기술한 후 상세한 대상을 지정하여 전역 규칙을 오버라이드 하면 된다.
# 네트워크 폴리시의 단점이 있다면 규칙 자체를 배치하는 것만으로는 아무 소용이 없다는 것이다.
# 인그레스 객체에 인그레스 컨트롤러가 필요했듯이, 네트워크 폴리시 객체 역시 클러스터에 정의된 규칙에 맞는 네트워크가 정의 되어있어야한다.

<!-- 실습 2 : 네트워크 폴리시 동작 안함 -->
# 네트워크 폴리시 객체 배치
kubectl apply -f apod/update/networkpolicy-api.yaml

# 배치 결과를 확인
kubectl get networkpolicy

# 아직 sleep 파드에서 APOD API에 접근이 가능한지 확인
# 네트워크폴리시 객체가 APOD API 파드에 APOD 웹 애플리케이션만 접근할 수 있도록 제약을 걸었지만 이 제약이 동작하지 않는다.
kubectl exec deploy/sleep -- curl -s http://apod-api/image
{"url":"https://apod.nasa.gov/apod/image/2401/GrivolaMoon_Micon_1080.jpg","caption":"Shadows of Mountain and Moon","copyright":"\nEnzo Massa Micon\n"}

# 쿠버네티스의 네트워크 계층은 플러그인 방식으로 교체 가능하다.
# 이런 네트워크 플러그인 중에는 네트워크 폴리시가 적용되지 않는 것이 있다.
# 표준 클러스터 배치에 사용되는 단순 네트워크가 그러하다
# 이런 사실을 알지 못하면 네트워크 폴리시 객체를 아무리 배치해도 네트워크에 실제 제약이 적용되지 않는 황당한 경우를 겪게 된다.

# 네트워크 폴리시의 지원여부는 클라우드 사업자에 따라 다르다.
# AKS에서는 클러스터를 생성할 때 네트워크 폴리시 사용여부를 지정할 수 있으며,
# EKS는 클러스터 생성 후 네트워크 플러그인을 직접 교체해야 네트워크 폴리시를 적용할 수 있다.

<!-- 실습 3 : 기존 클러스터에 접근이 가능한지 확인 -->
# 쿠버네티스 컨텍스트의 목록을 확인
kubectl config get-contexts

# 기존 클러스터로 컨텍스트를 전환
kubectl config set-context <기존_클러스터명>

# 기존 클러스터에 접근이 가능한지 확인
kubectl get nodes
