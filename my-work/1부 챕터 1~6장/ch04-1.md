<!-- 컨피그맵과 비밀값으로 애플리케이션 설정하기 -->
# 컨테이너에서 애플리케이션을 실행할 때 대표적인 장점 중 하나는 다양한 환경 간 차이를 원천적으로 없앨 수 있다는 점이다. 테스트 환경부터 운영 환경까지 전체 배포 절차가 컨테이너 하나로 이미지로 진행될 수 있기 때문에 모든 환경에서 완전히 동일한 바이너리가 사용된다.
# 물론 환경 간 차이가 아주 없을 수는 없다. 이를 위해 컨테이너 환경별로 설정값을 주입해야 한다.

# 쿠버네티스에서 컨테이너에 설정값을 주입하는데 쓰이는 리소스는 컨피그맵(ConfigMap) 과 비밀값(Secret) 두 가지다.
# 이 두가지 리소스 모두 포맷 제한 없이 데이터를 보유할 수 있다.
# 이 데이터는 클러스터 속에서 다른 리소스와 독립적인 장소에 보관된다.

<!-- 쿠버네티스에서 애플리케이션에 설정이 전달되는 과정 -->
# 컨피그맵과 비밀값 역시 다른 쿠버네티스 리소스와 마찬가지로 yaml 또는 kubectl의 create 명령어를 활용해 생성할 수있다.
# 다른 리소스와 달리 컨피그맵과 비밀값은 스스로 어떤 기능을 하지않고 단지 적은 양의 데이터를 저장하는 것이 목적이다.
# 이들 리소스는 파드로 전달되어 컨테이너 환경의 일부가 되고, 이상태에서 컨테이너가 컨피그맵이나 비밀값에 저장된 데이터를 읽을 수 있다.

# 그전에 가장 기본적인 수단인 환경변수를 알아보자

<!-- 환경변수 실습 -->

<!-- 환경변수가 설정되지 않을때 기본값 -->
# 챕터 4 들어가기
PS C:\ALL_WORKSPACE\0_GIT\kiamol> cd ch04

# sleep.yaml 파일 == 디플로이먼트 / image = kiamol/ch03-sleep / 레이블 셀렉터 app=sleep 
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch04> kubectl apply -f sleep/sleep.yaml
deployment.apps/sleep created

# 파드가 준비될 때까지 대기
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch04> kubectl wait --for=condition=Ready pod -l app=sleep
pod/sleep-568fb49bb7-2xv9z condition met

# 파드 속 컨테이너에 설정된 몇 가지 환경 변수의 값을 확인
# printenv는 환경 변수의 값을 출력하는 리눅스 명령어이다.
# HOSTNAME 환경 변수는 쿠버네티스가 파드 이름을 값으로 모든 컨테이너에 설정한다.
# 하지만 KIAMOL_CHAPTER 환경 변수는 정의되지 않은 상태이므로 오류 코드와 함꼐 종료되었다.
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch04> kubectl exec deploy/sleep -- printenv HOSTNAME KIAMOL_CHAPTER
sleep-568fb49bb7-2xv9z
command terminated with exit code 1

<!-- 환경변수가 설정된 값 -->
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sleep
spec:
  selector:
    matchLabels:
      app: sleep
  template:
    metadata:
      labels:
        app: sleep
    spec:
      containers:
        - name: sleep
          image: kiamol/ch03-sleep
          env:                    # 이 아래로 환경변수가 정의
          - name: KIAMOL_CHAPTER  # 새로운 환경 변수의 이름 정의
            value: "04"           # 새로운 환경변수의 값 정의

# sleep 디플로이먼트의 파드 정의를 위와 같이 수정하여 새로운 환경변수를 추가해보자

# sleep 디플로이먼트 수정
# 기존 디플로이먼트를 업데이터 한다. 환경변수를 추가하면서 파드 정의가 변경됐으므로 기존 파드가 새로운 파드로 교체된다.
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch04> kubectl apply -f sleep/sleep-with-env.yaml
deployment.apps/sleep configured

# 환경 변수의 값 확인
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch04> kubectl exec deploy/sleep -- printenv HOSTNAME KIAMOL_CHAPTER
sleep-675cc588c6-dwk2r
04

<!-- 컨피그맵 -->
# 컨피그맵은 파드에서 읽어 들이는 데이터를 저장하는 리소스이다. 
# 데이터의 형태는 한 개 이상의 키-값쌍 , 텍스트 , 바이너리 파일까지 다양하다.

# 키-값 쌍을 저장했다면 파드에서 이를 환경변수 형태로 주입할수 있다.
# 텍스트를 저장했다면 JSON , XML , YAML , TOML , INI 등 설정 파일을 파드에 전달할 수 있다.
# 바이너리 파일 형태로 된 라이선스 키를 전달하는 것도 가능하다.

# 또한 하나에 여러개의 컨피그맵을 전달할 수 있고 , 반대로 하나의 컨피그맵을 여러 파드에 전달할 수도 있다.

# 주의점 
1) 파드가 컨피그맵을 읽어서 온다.
2) 컨피그맵은 특정 애플리케이션 전용으로 사용하거나 여러 파드에서 공유하는 형태로도 사용가능
3) 컨피그맵은 읽기 전용이다.
4) 파드에서 컨피그맵은 수정할 수 없다.

<!-- sleep-with-configMap-env.yaml -->
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sleep
spec:
  selector:
    matchLabels:
      app: sleep
  template:
    metadata:
      labels:
        app: sleep
    spec:
      containers:
        - name: sleep
          image: kiamol/ch03-sleep
          env:
          - name: KIAMOL_CHAPTER
            value: "04"
          - name: KIAMOL_SECTION
            valueFrom:
              configMapKeyRef:              # 이값은 컨피그맵에서 읽어 들이라는 의미            
                name: sleep-config-literal  # 컨피그맵 이름
                key: kiamol.section         # 컨피그맵에서 읽어 들일 항목 이름

# kubectl create 명령어로 configMap을 만든다.
# kiamol.section 키의 값으로 4.1이 설정되었다.
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch04> kubectl create configmap sleep-config-literal --from-literal=kiamol.section='4.1'
configmap/sleep-config-literal created

# 컨피그맵에 들어있는 데이터 확인
# 이 컨피그맵의 상세 정보를 보면 데이터 항목이 하나뿐이다.
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch04> kubectl get cm sleep-config-literal
NAME                   DATA   AGE
sleep-config-literal   1      14s

# 컨피그맵의 상세 정보를 보기 좋게 출력
# 컨피그맵의 상세 정보를 보면 이 객체의 메타데이터 및 저장된 데이터 값을 볼 수 있다.
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch04> kubectl describe cm sleep-config-literal
Name:         sleep-config-literal
Namespace:    default
Labels:       <none>
Annotations:  <none>

Data
====
kiamol.section:
----
4.1

BinaryData
====

Events:  <none>

# 파드 속 환경 변수가 적용되었는지 확인
# 컨피그맵에 담긴 데이터를 읽어 들여 환경 변수로 설정했다.
# 이때 키는 사용하지 않고 환경변수의 이름을 바꾸었다.
# 나머지 환경변수는 YAML 파일에서 정의된 것이다.
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch04> kubectl apply -f sleep/sleep-with-configMap-env.yaml
deployment.apps/sleep configured
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch04> kubectl exec deploy/sleep -- sh -c 'printenv | grep "^KIAMOL"'
KIAMOL_SECTION=4.1
KIAMOL_CHAPTER=04