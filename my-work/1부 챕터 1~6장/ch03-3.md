<!-- 외부 트래픽을 파드로 전달하기 -->

# 로드 밸런서라는 유형의 서비스를 이용하여 로컬 개발환경과 운영환경 어디라도 적용할 수 있는 방법을 익혀보자

# 로드 밸런서 서비스의 커버 범위는 클러스터 전체이다.

# 따라서 어느 노드에 있는 파드라도 트래픽을 전달할 수 있다.

# 로드 밸런서 서비스는 클러스터로 트래픽을 전달해주는 외부 로드밸런서와 함꼐 동작하며, 레이블 셀렉터와 일치하는 파드로 트래픽을 전달한다.

<!-- numbers/web-service.yaml -->

apiVersion: v1
kind: Service
metadata:
name: numbers-web
spec:
ports: - port: 8080 # 서비스가 주시하는 포트
targetPort: 80 # 트래픽이 전달될 파드의 포트
selector:
app: numbers-web
type: LoadBalancer # 외부 트래픽도 전달할 수 있는 서비스

# 이 서비스가 클러스터에 배포되면 kubectl 로 따로 포트포워딩을 설정하지 않아도 웹 애플리케이션에 접근할 수 있다.

  <!-- 실습 -->

# 앞서 정의한 로드밸런서 서비스를 클러스터에 배치하고, kubectl을 사용해서 해당 서비스의 IP주소를 찾아라

# 로드밸런서 서비스를 배치한다.
# 방화벽에서 접근 허용여부를 묻는다면 허용하라
C:\ALL_WORKSPACE\0_GIT\kiamol\ch03>kubectl apply -f numbers/web-service.yaml
service/numbers-web created

# CLUSTER-IP : 로드밸런서 서비스에는 클러스터 IP가 함께 부여된다.
# 클러스터 안에 있는 다른파드는 서비스 이름으로 서비스에 접근한다.
# 로드밸런서 서비스는 외부 IP주소를 주시하다가 해당 주소로 들어오는 트래픽을 클러스터로 전달한다.
# EXTERNAL-IP : 이 주소는 클러스터에서 제공되는 주소이다.
C:\ALL_WORKSPACE\0_GIT\kiamol\ch03>kubectl get svc numbers-web
NAME          TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE
numbers-web   LoadBalancer   10.107.18.45   localhost     8080:31421/TCP   14s

# 애플리케이션의 url을 EXTERNAL-IP필드로 출력한다.
C:\ALL_WORKSPACE\0_GIT\kiamol\ch03>kubectl get svc numbers-web -o jsonpath='http://{.status.loadBalancer.ingress[0].\*}:8080'
'http://localhost:8080'

# 이제 별도의 kubectl을 사용하여 포트포워딩을 설정하지 않아도 웹 애플리케이션에 접근할 수 있다.

<!-- 노드포트(NODE-PORT) --> 
# 외부에서 클러스터로 들어오는 트래픽을 파드로 전달하는 역할을 하는 서비스 리소스의 유형이 한가지 더 있다. 이를 노드포트(NODE-PORT)라고 한다.

# 노드포트 서비스는 외부 로드밸런서가 필요없다.
# 클러스터를 구성하는 모든 노드가 이 서비스에 지정된 포트를 주시하며 들어온 트래픽을 대상 파드의 대상 포트로 전달한다.
# 노드포트 서비스는 서비스에서 설정된 포트가 모든 노드에서 개방되어 있어야 하기 때문에 로드 밸런서 서비스만큰 유연하지는 않다.
# 때문에 K3s나 도커 데스크톱에서는 잘 동작하지만, kind에서는 그렇지 못하다

<!-- numbers-service/web-service-nodePort.yaml -->
apiVersion: v1
kind: Service
metadata:
  name: numbers-web-node
spec:
  ports:
    - port: 8080      # 다른 파드가 서비스에 접근하기 위해 사용하는 포트
      targetPort: 80  # 대상 파드에 트래픽을 전달하는 포트
      nodePort: 30080 # 서비스가 외부에 공개되는 포트
  selector:
    app: numbers-web
  type: NodePort      # 노드의 IP주소를 통해 접근 가능한 서비스 정의


