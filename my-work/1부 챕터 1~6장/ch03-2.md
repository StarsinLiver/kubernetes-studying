<!-- 파드와 파드간의 통신 -->
# 서비스 유형 중 가장 기본이 되는 것은 클러스터IP라고 함
# 클러스터IP 주소는 클러스터 내에서만 유효하기 때문에 클러스터IP는 파드와 파드간 통신에서만 쓰인다.
# 내부에서는 접근이 가능하되 외부의 접근은 차단해야 하는 분산 시스템의 컴포넌트에 딱 적합하다.

# 두개의 디플로이먼트를 실행하라. 하나는 웹 애플리케이션, 다른 하나는 API역할을 담당한다.
# 이 애플리케이션에는 아직 서비스가 없다. 따라서 웹 애플리케이션이 API에 접근하지 못해 애플리케이션이 제대로 동작하지 않은 상태다.

# 웹 사이트와 api를 담당할 두개의 디플로이먼트를 실행한다.
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch03> kubectl apply -f numbers/api.yaml -f numbers/web.yaml
deployment.apps/numbers-api created
deployment.apps/numbers-web created

# 파드의 준비가 끝날 때까지 기다린다.
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch03> kubectl wait --for=condition=Ready pod -l app=numbers-web
pod/numbers-web-76447f6964-prltr condition met

# 웹 애플리케이션에 포트포워딩을 적용한다.
# 웹 애플리케이션 파드와 api 파드를 배포했지만 서비스는 생성하지 않았다.
# 따라서 이들 두 컴포넌트가 서로 통신하지 못한다.
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch03> kubectl port-forward deploy/numbers-web 8080:80
Forwarding from 127.0.0.1:8080 -> 80
Forwarding from [::1]:8080 -> 80
Handling connection for 8080

# 웹브라우저에서 http://localhost:8080에 접근하여
# 화면상의 Go 버튼을 클릭하면 오류가 발생
# 웹 애플리케이션이 동작하기는 하지만 api호출에 실패하여 오류가 발생

# 이번엔 API에 접근하기 위해 도메인 조회가 가능하도록 서비스를 배포하라. 트래픽이 실제로 API파드에 전달되는지 확인하라

<!-- 서비스는 파드와 파드간의 대문역할을 한다. -->
# 예제 서비스를 배포
# 이 서비스 정의에 웹 애플리케이션이 api 접근하는데 사용하는 도메인 네임이 포함되어있다.
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch03> kubectl apply -f numbers/api-service.yaml
service/numbers-api created

# 서비스의 상세 정보를 출력
# 서비스의 IP주소가 API파드의 대문 역할을 한다.
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch03> kubectl get svc numbers-api
NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
numbers-api   ClusterIP   10.104.181.34   <none>        80/TCP    10s

# 웹 애플리케이션에 접근할 수 있도록 포트포워딩을 적용
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch03> kubectl port-forward deploy/numbers-web 8080:80
Forwarding from 127.0.0.1:8080 -> 80
Forwarding from [::1]:8080 -> 80
Handling connection for 8080
Handling connection for 8080

<!-- 파드를 지우더라도 레이블 셀렉터가 일치하므로 동작가능 -->
# API 파드는 디플로이먼트가 관리한다. 따라서 수동으로 파드를 지우더라도 대체 파드가 생성됨
# 새로 생성된 파드 역시 API 서비스에 정의된 레이블 셀렉터와 일치하므로 새로운 파드에도 트래픽이 연결되며 애플리케이션도 기존처럼 잘 동작한다.

# api 파드의 이름과 IP주소를 확인
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch03> kubectl get pod -l app=numbers-api -o custom-columns=NAME:metadata.name,POD_IP:status.podIP
NAME                           POD_IP
numbers-api-545b9d9ccd-7m258   10.1.0.40

# api 파드를 수동으로 삭제한다.
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch03> kubectl delete pod -l app=numbers-api
pod "numbers-api-545b9d9ccd-7m258" deleted

# 새로 생성된 대체 파드의 이름과 ip주소를 확인
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch03> kubectl get pod -l app=numbers-api -o custom-columns=NAME:metadata.name,POD_IP:status.podIP
NAME                           POD_IP
numbers-api-545b9d9ccd-f94r8   10.1.0.41

# 웹 애플리케이션에 포트포워딩을 적용한다.
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch03> kubectl port-forward deploy/numbers-web 8080:80
Forwarding from 127.0.0.1:8080 -> 80
Forwarding from [::1]:8080 -> 80
Handling connection for 8080