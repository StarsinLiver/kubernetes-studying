<!-- 데몬셋과 스테이트풀셋의 롤링 업데이트 -->
# 데몬셋과 스테이트풀셋에도 두가지 업데이트 전략이 있다.
# 기본값은 이 절에서 다룰 롤링 업데이트(rolling update) 이고 두번째는 온딜리트(OnDelete)이다.

<!-- 온딜리트 전략 -->
# 온딜리트 전략은 각 파드의 업데이트 시점을 직접 제어해야 할 때 사용하는 전략이다.
# 업데이트를 배치하면 컨트롤러가 기존 파드를 종료하지 않고 그대로 둔 채 파드를 주시한다.
# 그러다 다른 프로세스가 파드를 삭제하면 새로운 정의를 따른 대체 파드를 생성하는 방식이다.

# 제거되기 전에 가지고 있는 데이터를 모두 디스크에 기록해야 하는 파드를 관리하는 스테이트풀셋을 생각해보자 또한 다음 파드가 사용할 수 있도록 종료 전 전용 하드웨어에서 접속을 해제해야 하는 파드를 관리하는 데몬셋은 어떤가.
# 그리 흔한 경우는 아니지만, 이때도 온딜리트 전략을 사용하면 파드의 제거 시점은 사용자가 직접 통제하되 삭제된 파드를 쿠버네티스가 자동으로 대체하게끔 할 수 있다.

<!-- 실습 -->
# 이 애플리케이션은 스테이트풀셋으로 데이터베이스를 실행하며 디플로이먼트에서 웹 애플리케이션을, 데몬셋으로 리버스 프록시를 관리한다.

# to-do 애플리케이션, 데이터베이스, 리버스 프록시를 배치
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch09> kubectl apply -f .\todo-list\db\ -f .\todo-list\web\ -f .\todo-list\proxy\
configmap/todo-db-config configured
configmap/todo-db-env configured
configmap/todo-db-scripts configured
secret/todo-db-secret configured
service/todo-db created
statefulset.apps/todo-db created
configmap/todo-web-config configured
secret/todo-web-secret configured
service/todo-web created
deployment.apps/todo-web created
configmap/todo-proxy-configmap created
service/todo-proxy created
daemonset.apps/todo-proxy created

# 애플리케이션 URL을 생성
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch09> kubectl get svc todo-proxy -o jsonpath='http://{.status.loadBalancer.ingress[0].*}:8091'
http://localhost:8091

# 웹 브라우저에서 애플리케이션에 접근
# 할일 항목을 추가하고 새 항목이 목록에 추가되는지 확인

# 첫번째 업데이트는 데몬셋을 대상으로 한다. nginx 프록시 이미지의 새 버전을 롤아웃할 거싱다.
# 데몬셋은 클러스터의 모든 (또는 일부) 노드에 파드를 하나씩만 실행하므로 롤링 업데이트를 할 때 잉여 파드를 만들 수 없으며, 삭제 후 제거 전략만 가능하다.
# maxUnavailable 값을 조정하여 동시에 업데이트할 노드 개수를 조절할 수 있지만, 여러 개의 파드를 한번에 제거하면 파드가 대체될 때까지 그만큼 처리 용량이 감소한다.
# 프록시 업데이트에는 maxUnavailable 값을 1로, minReadySeconds 값을 90으로 설정한다.
# 지금은 실습용 단일 노드 클러스터이므로 지연 시간이 아무 소용없다.
# 하지만 규모가 큰 클러스터에서는 한번에 한 파드씩 업데이트하면서 그때마다 90초씩 대기하게 되므로 업데이트된 파드가 안정적인지 확인한 후에 다음 파드의 업데이트를 진행하는 효과가 있다.

<!-- 실습 2 -->
# 데몬셋을 롤링 업데이트 전략으로 업데이트한다.
# 단일 노드 클러스터이므로 파드가 교체될때까지 잠시 서비스를 사용할 수 없다.
<!-- daemonset/update -->
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: todo-proxy
  labels:
    kiamol: ch09
spec:
  selector:
    matchLabels:
      app: todo-proxy
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  minReadySeconds: 90
...


# 데몬셋 업데이트
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch09> kubectl apply -f .\todo-list\proxy\update\nginx-rollingUpdate.yaml
daemonset.apps/todo-proxy configured

# 파드의 업데이트 상태를 확인
# kubectl 명령의 --watch 플래그는 변경 사항을 모니터링할 때 유용하다.
# 객체를 계속 주시하다가 객체의 상태가 변화할 때마다 그 내용을 화면에 출력한다.
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch09> kubectl get po -l app=todo-proxy --watch
NAME               READY   STATUS              RESTARTS   AGE
todo-proxy-95mr9   0/1     ContainerCreating   0          10s
todo-proxy-95mr9   1/1     Running             0          11s

# 업데이트가 완료되면 ctrl+c 를 누른다.

# 여기에서는 대체 파드가 생성되기 전 기존 파드가 제거되는 모습을 볼 수 있다
# 이것으로 대체 파드가 준비될 때까지 애플리케이션을 사용할 수 없는 상태가 된다.
# 이 업데이트로 1초의 중단 시간이 발생한것을 알 수 있다.

# 노드가 두 개이상인 클러스터에서는 이런 중단시간이 발생하지 않는다.
# 서비스는 준비 상태인 파드에만 트래픽을 전달하는데, 파드가 한번에 하나씩 업데이트되므로 항상 최소한 파드 하나는 준비 상태를 유지하기 때문이다.
# 또한 maxUnavailable 값을 더 크게 조정하면 처리용량은 그만큼 감소하겠지만, 한번에 여러개의 파드를 업데이트할 수 있다.
# 데몬셋의 업데이트에서 조절할 수 있는 부분은 이것뿐이다.
# 간단히 말하면 파드를 일일이 수동으로 업데이트하거나 쿠버네티스를 이용하여 원하는 숫자만큼 한번에 업데이트하느냐 정도의 차이만 있다.

<!-- 스테이트풀셋에서의 업데이트 -->
# 스테이트풀셋의 업데이트에서는 maxSurge나 maxUnavailable 등 설정은 사용할 수 없다.
# 동시에 업데이트되는 파드 수는 항상 하나다.
# 다만 partition 값을 이용하여 전체 파드 중 업데이트해야하는 파드의 비율은 설정할 수 있다.
# 지정된 비율의 파드에 업데이트되면 롤아웃이 중단한다.

# 유상태 애플리케이션에서 단계별 롤아웃을 수행할 때 유용하다.

<!-- 실습 3 -->
# 스테이트풀셋에 partition 설정이 적용된 업데이트를 배치하라 업데이트 결과는 파드 1만 업데이트되며 파드 0은 업데이트 되지 않는다.

<!-- statefulSet/partition -->
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: todo-db
  labels:
    kiamol: ch09
spec:
  replicas: 2
  selector:
    matchLabels:
      app: todo-db
  serviceName: todo-db  
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      partition: 1  # only updates Pod 1
  template:
    metadata:
      labels:
        app: todo-db
...

# 업데이트를 배치
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch09> kubectl apply -f .\todo-list\db\update\todo-db-rollingUpdate-partition.yaml
statefulset.apps/todo-db configured

# 롤아웃의 상태를 확인
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch09> kubectl rollout status statefulset/todo-db
Waiting for partitioned roll out to finish: 0 out of 1 new pods have been updated...
Waiting for 1 pods to be ready...
Waiting for 1 pods to be ready...
Waiting for 1 pods to be ready...
Waiting for 1 pods to be ready...
partitioned roll out complete: 1 new pods have been updated...

# 파드의 목록에서 실행 시각과 이미지 이름을 확인
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch09> kubectl get pods -l app=todo-db -o=custom-columns=NAME:.metadata.name,IMAGE:.spec.containers[0].image,START_TIME:.status.startTime
NAME        IMAGE                  START_TIME
todo-db-0   postgres:11.6-alpine   2024-01-16T13:47:26Z
todo-db-1   postgres:11.8-alpine   2024-01-16T14:04:58Z // 1번만 업데이트됨

# 웹 애플리케이션을 읽기 전용모드로 전환하여 데이터베이스 부 인스턴스만 사용하도록 함
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch09> kubectl apply -f todo-list/web/update/todo-web-readonly.yaml
deployment.apps/todo-web configured

# 애플리케이션을 테스트한다. 데이터를 볼 수 있지만 수정할 수는 없다.

# 롤아웃이 끝났는데도 서로 다른 정의의 파드가 함께 동작중이다.
# 스테이트풀셋에서 동작하는 데이터 위주의 애플리케이션에는 롤아웃 중 파드를 업데이트할 때마다 실행하는 일련의 검증 작업이 갖추어질때가 많은데, 여기에서도 이 검증 작업을 이용할 수 있다.
# partition 값을 차츰 줄여가며 릴리스의 페이스를 조절하다 업데이트가 안정적임을 확인한 후 partition 값을 0으로 설정해서 전체 스테이트풀셋을 업데이트 하면 된다.

<!-- 실습 4 -->
# 데이터베이스의 주 인스턴스를 업데이트 해보자
# partition 설정값만 제거하면 된다.

# 업데이트를 배치
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch09> kubectl apply -f .\todo-list\db\update\todo-db-rollingUpdate.yaml
statefulset.apps/todo-db configured

# 업데이트 진행 상황을 확인
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch09> kubectl rollout status statefulset/todo-db
waiting for statefulset rolling update to complete 1 pods at revision todo-db-d77d4cdc5...
Waiting for 1 pods to be ready...
Waiting for 1 pods to be ready...
Waiting for 1 pods to be ready...
statefulset rolling update complete 2 pods at revision todo-db-d77d4cdc5...

# 파드이 정의는 그대로이다.
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch09> kubectl get pods -l app=todo-db -o=custom-columns=NAME:.metadata.name,IMAGE:.spec.containers[0].image,START_TIME:.status.startTime
NAME        IMAGE                  START_TIME
todo-db-0   postgres:11.8-alpine   2024-01-16T14:10:53Z
todo-db-1   postgres:11.8-alpine   2024-01-16T14:04:58Z

# 부 인스턴스로 읽기 전용모드로 바꿈
PS C:\ALL_WORKSPACE\0_GIT\kiamol\ch09> kubectl apply -f .\todo-list\web\todo-web.yaml
deployment.apps/todo-web configured

# 애플리케이션을 테스트해서 업데이트된 데이터베이스
# 주 인스턴스가 제대로 동작하는지 확인한다.

# 결과를 보면 스테이트풀셋의 모든 파드가 업데이트되어 주 인스턴스 역시 부 인스턴스와 같은 버전이 되었다.
# 복제본 설정이 된 데이터베이스를 업데이트 해본적이 있다면 이것이 얼마나 간단해졌는지 알 수 있을 것이다. 매니지드 데이터베이스 서비스를 쓰지 않는 한 이보다 더 간단해질 수는 없다.

<!-- 넘어가며 -->
# 디플로이먼트와 데몬셋, 스테이트풀셋은 모두 기본적으로 롤링 업데이트전략을 사용한다.
# 큰 틀에서 볼때 이들 리소스에서 롤링 업데이트는 기존 파드를 점진적으로 변경된 정의의 파드로 대체해 나간다는 점에서 비슷하다.
